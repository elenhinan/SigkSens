<html>
<head>
  <title>Deltas</title>
  <meta charset="utf-8">
  <script type="text/javascript">
    var WebSocket = WebSocket || MozWebSocket;
    var lastDelta = Date.now();
    var serverWsUrl = "ws://" + window.location.hostname + ":81";
    var serverUrl = "http://" + window.location.hostname;
    //var serverWsUrl = "ws://192.168.0.53:81"; // for development uncomment
    //var serverUrl = "http://192.168.0.53";
    var paths = {};
    var pathAge = {};
    connection = new WebSocket(serverWsUrl);

    connection.onopen = function(evt) {
      console.log("Connected!");
      document.getElementById("box").innerHTML = "Status: Connected!";
    };

    connection.onmessage = function(evt) {
      var msg = JSON.parse(evt.data);
      
      msg.updates[0].values.forEach(function(pathData) {
        paths[pathData['path']] = pathData['value'];
        pathAge[pathData['path']] = Date.now();
        });

      updateValues()
      
      lastDelta = Date.now();
    };

    function updateValues() {
      var newTbody = "";
      for (var path in paths) {
        newTbody = newTbody + "<tr><td>"+ path + "</td><td>" + paths[path] + "</td><td>" + ((Date.now() - pathAge[path])/1000).toFixed(1) + "</td></tr>";
      }
      document.getElementById("deltaValues").innerHTML = newTbody;
    }

    setInterval(function(){
      document.getElementById("age").innerHTML = "Time since last delta: " + ((Date.now() - lastDelta)/1000).toFixed(1) + " seconds";
      updateValues();
    }, 50);


        /* get config */
    function getConfig() {
      fetch(serverUrl + "/getConfig")
      .then((resp) => resp.json())
      .then(function(data) { 
        var newTbody = "";
        Object.keys(data).sort().forEach(function(key, idx) {
          newTbody = newTbody + "<tr><td>" + key + "</td><td>";
          switch (data[key].dataType) {
            case "string":
              newTbody = newTbody + "<input id=\"" + key + "\" type='text' value=\"" + data[key].value + "\">";
              break;
            case "boolean":
              newTbody = newTbody + "<select id=\"" + key + "\"><option value='true'";
              if (data[key].value) { newTbody = newTbody + " SELECTED" ;} 
              newTbody = newTbody + ">True</option><option value='false'";
              if (!data[key].value) { newTbody = newTbody + " SELECTED" ;}
              newTbody = newTbody + ">False</Option></select>";
              break;            
            case "int8":
              newTbody = newTbody + "<input id=\"" + key + "\" type='number' min=-127 max=127 value=\"" + data[key].value + "\">";
              break;
            case "uint8":
              newTbody = newTbody + "<input id=\"" + key + "\" type='number' min=0 max=255 value=\"" + data[key].value + "\">";
              break;
            case "int16":
              newTbody = newTbody + "<input id=\"" + key + "\" type='number' min=-32767 max=32767 value=\"" + data[key].value + "\">";
              break;          
            case "uint16":
              newTbody = newTbody + "<input id=\"" + key + "\" type='number' min=0 max=65535 value=\"" + data[key].value + "\">";
              break;          
            case "int32":
            case "uint32":
              newTbody = newTbody + "<input id=\"" + key + "\" type='number'value=\"" + data[key].value + "\">";
              break;          
          }

          newTbody = newTbody + "</td><td><button id=\"button"+key+"\" onclick=\"postConfig('"+key+"', '"+ data[key].dataType +"')\">Set</button></td></tr>";
          
        });
        document.getElementById("formTable").innerHTML = newTbody;
        
      })
      .catch(function(error) { console.log(error); alert(error); });
    }


    // POST Config
    function postConfig(configKey, configDataType) {
      document.getElementById("button"+configKey).innerHTML = "Saving";
      let newValue = document.getElementById(configKey).value;
      let data = "key=" + encodeURIComponent(configKey) +"&dataType=" + encodeURIComponent(configDataType) + "&value=" + encodeURIComponent(newValue);
      let fetchData = { 
        method: 'POST', 
        body: data,
        headers: { 'Content-type': 'application/x-www-form-urlencoded;charset=UTF-8' }
      };
      fetch(serverUrl + "/set", fetchData)
      .then((resp) => resp.json())
      .then(function(data) { 
        document.getElementById("button"+configKey).innerHTML = "Saved!";
        console.log(data);
      })
      .catch(function(error) { 
        document.getElementById("button"+configKey).innerHTML = "Error!";
        console.log(error); alert(error); });

    }

    function getURL(url, buttonId, reloadConfig = false) {
      fetch(serverUrl + url)
      .then((resp) => resp.json())
      .then(function(data) { 
        document.getElementById(buttonId).innerHTML = "Done!";
        if (reloadConfig) { 
          setTimeout(function(){ getConfig(); }, 1000); //getConfig grabs config from flash, need to leave time for config to be written to flash :)
        }
        console.log(data);
      })
      .catch(function(error) { 
        document.getElementById(buttonId).innerHTML = "Error!";
        console.log(error); alert(error); });
    }

    getConfig(); //get config initially
  </script>
  <style>
html {
  font-family: Helvetica;
  display: inline-block;
  margin: 0px auto;
  text-align: center;
  }
h1{
  color: #0F3376;
  padding: 2vh;
}
p{
  font-size: 1.5rem;
}
table{
  margin-left:auto; 
  margin-right:auto;
}
th {
  background-color: rgb(158, 233, 247);
}
th, td {
  border-bottom: 1px solid #ddd;
}
form {
  margin-block-end: 0px;
}
  </style>
</head>
<body>
  <h1>SigKSens</h1>
  <h2>Current Values</h2>
  <table>
    <thead>
      <tr><th>Path</th><th>Value</th><th>Age</th></tr>
    </thead>
    <tbody id="deltaValues">
    </tbody>
  </table>
  <div id="box">Status: Not Connected yet</div>
  <div id="age"></div>
  <h2>Actions</h2>
  <div>
    <button id="buttonReboot" onclick="getURL('/restart', 'buttonReboot')">Reboot</button>
    <button id="buttonReset" onclick="getURL('/resetConfig', 'buttonReset')">Reset all Configuration</button>
    <button id="buttonDiscover" onclick="getURL('/rediscover', 'buttonDiscover', true)">Rediscover server</button>
  </div>
  <h2>Configuration</h2>
  <table>
    <thead>
      <tr><th>Config</th><th>Value</th><th></th></tr>
    </thead>
    <tbody id="formTable">
    </tbody>
  </table>
</body>
</html>